---
title: vue3ä¸­composition apiï¼ˆç»„åˆå¼apiï¼‰çš„ä½¿ç”¨
date: 2021-03-20
tags:
  - å‰ç«¯
  - vue
categories: code
pic:
desc:
---

åœ¨ä¹‹å‰çš„ä¸€ç¯‡åšå®¢ä¸­ï¼Œæˆ‘æåˆ°äº† vue3 ä¸­çš„ä¸€ä¸ªéå¸¸é‡è¦çš„ç‰¹æ€§ [ç»„åˆå¼](https://vue3js.cn/docs/zh/guide/composition-api-introduction.html) ï¼Œå› ä¸ºé‚£ç¯‡æ–‡ç« æ˜¯å¯¹ vue3 ä¸­ä¸€ä¸ªæ€»ä½“çš„æ¦‚è¿°ï¼Œæ‰€ä»¥ç”¨è¿™ç¯‡å•è°ˆè°ˆç»„`åˆå¼api`

## ç»„åˆå¼ api å‡ºç°çš„åŸå› 

å¦‚æœä½ åŒæ—¶æ˜¯ä¸€ä¸ª react å¼€å‘è€…ï¼Œä¸€å®šä¼šå¯¹ react ä¸­çš„ hooks å¤§åŠ èµèµï¼Œvue ä¸­çš„ç»„åˆå¼ api æˆ‘è®¤ä¸ºå’Œ react ä¸­çš„ hooks æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ã€‚

å®ƒçš„å‡ºç°ä¸»è¦æ˜¯ä¸ºäº†è§£å†³åŒç»„ä»¶ä¸­**ä¸åŒæ¨¡å—ä»£ç æ··æ·†éš¾ä»¥ç»´æŠ¤çš„é—®é¢˜** ï¼Œåœ¨ vue2 çš„æ—¶ä»£ï¼Œæ•°æ®å’Œæ–¹æ³•éƒ½æ”¾ç½®åœ¨ä¸åŒçš„å—ä¸­ï¼Œåƒä¸‹é¢è¿™å¼ å›¾

![alt](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/69e4ed25e71843928c8eb480a22b5129~tplv-k3u1fbpfcp-zoom-1.image)
![alt](//photo.tuituisoft.com/picgo/20210309102922.png)

å¦‚æœæˆ‘ä»¬è¦æ‰¾å‡ºå•ç‹¬ä¸€ä¸ªåŠŸèƒ½çš„æ‰€æœ‰ç›¸å…³å±æ€§ï¼Œå°±éœ€è¦ä¸æ–­çš„åœ¨è¿™äº› Api ä¸­ç¿»é˜…ã€‚å¦‚æœä¸€ä¸ªç»„ä»¶å˜çš„åºå¤§æ—¶å°±ä¼šå˜å¾—éš¾ä»¥ç»´æŠ¤ï¼Œvue2 å¯¹æ­¤çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ `mixins`ï¼Œä½† mixin ä¹Ÿä¼šé‡åˆ°ä¸€ä¸‹çš„é—®é¢˜

1. å‘½åå†²çªã€‚ä¸”å®¹æ˜“é‡åˆ°ä¸æ¸…æ™°çš„æƒ…å†µ
2. å¤ç”¨æ—¶å¯èƒ½å‡ºç°ä¸€äº›é—®é¢˜

**ç»„åˆå¼ api** è§£å†³äº†ä»¥ä¸Šçš„é—®é¢˜ã€‚è®©ä»£ç å˜çš„æ›´åŠ çš„æ˜“äºç»´æŠ¤å’Œå¤ç”¨ã€‚

![alt](//photo.tuituisoft.com/picgo/20210309103452.png)

## setup

setup æ˜¯ç»„åˆå¼ api çš„å…¥å£ï¼Œæˆ‘ä»¬æ‰€æœ‰çš„ç»„åˆå¼ api éƒ½å¿…é¡»è¦åœ¨ setup ä¸­ä½¿ç”¨æ‰å¯ä»¥ç”Ÿæ•ˆï¼Œå®ƒçš„è°ƒç”¨æ—¶æœºåœ¨åŸæ¥çš„é’©å­`beforeCreate`ä¹‹å‰

```js
export default {
  beforeCreate() {
    console.log("beforeCreate");
  },
  setup() {
    console.log("setup");
  },
};
```

![alt](//image.woai996.com/picGo/20210320095027.png)

## setup çš„å‚æ•°

|  name   | desc             |
| :-----: | ---------------- |
|  props  | çˆ¶ç»„ä»¶ä¼ å…¥çš„å±æ€§ |
| content | ä¸Šä¸‹æ–‡           |

```js
setup(props,ctx) {
  console.log('setup');
}
```
`props`è¿™ä¸ªæ²¡å•¥å¥½è¯´çš„ï¼Œå°±æ˜¯çˆ¶ç»„ä»¶ä¼ è¿‡æ¥çš„æ•°æ®åœ¨è¿™é‡Œå¯ä»¥æ¥å—åˆ°ï¼Œå¹¶ä¸”ï¼Œpropsçš„æ•°æ®æ˜¯å“åº”å¼çš„

:::warning
ç”±äºpropséœ€è¦ä½¿ç”¨åˆ°`Proxy`è¿›è¡Œæ•°æ®æ‹¦æˆªï¼Œæ‰€ä»¥å¦‚æœå¯¹å…¶ä½¿ç”¨es6çš„ç»“æ„ä¼šå¯¼è‡´æ•°æ®å¤±å»å“åº”å¼çš„åŠŸèƒ½
:::

å› ä¸ºåœ¨setupä¸­æ²¡æœ‰`this`çš„æ¦‚å¿µï¼Œæ‰€ä»¥ä»¥å‰ç‹ æ¯’çš„æ–¹æ³•æˆ‘ä»¬éƒ½æ— æ³•ä½¿ç”¨ä¼ ç»Ÿæ–¹å¼ï¼Œåœ¨`ctx`ä¸­æœ‰thisçš„æœ€å¸¸è§çš„ä¸‰ä¸ªæ–¹æ³•`attrsã€slot å’Œemit` 

![alt](//image.woai996.com/picGo/20210320095651.png)



## å“åº”å¼æ•°æ®

åœ¨ç»„åˆå¼apiä¸­ï¼Œå¦‚æœåœ¨è§†å›¾ä¸­æˆ‘ä»¬è¦ä½¿ç”¨åˆ°çš„å±æ€§æˆ–è€…ï¼Œéœ€è¦åœ¨setupå‡½æ•°ä¸­returnå‡ºå»ï¼Œä½†é»˜è®¤æ•°æ®æ˜¯æ²¡æœ‰å“åº”å¼çš„

```vue
<template>
  <div>{{ msg }}</div>
  <button @click="fn">æŒ‰é’®</button>
</template>
<script>
export default {
  setup() {
    let  msg = `æˆ‘æ˜¯ç»„åˆå¼apiçš„æ•°æ®`
    function fn() {
      console.log('æˆ‘æ˜¯ç»„åˆå¼apiçš„æ–¹æ³•');
      msg = 'æ›´æ”¹msg' // æ— æ•ˆï¼Œæ•°æ®ä¸ä¼šæ›´æ–°
    }
    return {
      msg,
      fn
    };
  },
};
</script>
```

å¦‚æœæˆ‘ä»¬è¦å®šä¹‰ç»„ä»¶è‡ªå·±çš„å“åº”å¼æ•°æ®ï¼Œéœ€è¦ä½¿ç”¨åˆ°`ref` å’Œ`reactive` ä¸¤ä¸ªapiæ¥ä½¿æ•°æ®å˜æˆå“åº”å¼æ•°æ®


### ref å’Œ reactive 

è¿™ä¸¤ä¸ªapiéƒ½æ˜¯å¯ä»¥ä½¿ `setup` å†…æ•°æ®å˜æˆå“åº”å¼çš„api


**`ref` çš„ä½¿ç”¨**
```vue
<template>
  <button @click="up">click</button>
  <div>{{ count }}</div>
</template>

<script>
import { ref } from "vue";

export default {
  setup() {
    let count = ref(0);
    function up() {
      count.value++;
    }
  
    return {
      count,
      up,
    };
  },
};
</script>
```

**`reactive` çš„ä½¿ç”¨** 

```vue
<template>
  <button @click="up">click</button>
  <h2> åå­—: {{state.name}}  å¹´é¾„ {{state.age}} </h2>
</template>
<script>
import { reactive } from "vue";
export default {
  setup() {
    let state = reactive({
      age:18,
      name:'æå››'
    });
    function up() {
      state.age ++
    }
  
    return {
      state,up
    };
  },
};
</script>
```

ä½¿ç”¨ä»–ä»¬ä¸¤è€…çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

`ref`æ›´é€‚åˆå¯¹äºåŸºç¡€ç±»å‹æ•°æ®çš„å®šä¹‰ï¼Œ`reactive`æ›´é€‚åˆå¯¹äºå¯¹è±¡å½¢å¼æ•°æ®å®šä¹‰ã€‚

ä¸æ˜¯è¯´`ref`ä¸èƒ½å¤„ç†å¯¹è±¡ç±»å‹çš„æ•°æ®ï¼Œè€Œæ˜¯æ¥ä¸‹æ¥çš„ä¸€ä¸ªapi`toRefs`å¯ä»¥å°†`reactive`å®šä¹‰çš„å¯¹è±¡ç»“æ„å‡ºæ¥ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨æ•°æ®æ—¶å°±ä¸éœ€è¦å† `obj.xxx` è¿™æ ·çš„æ ¼å¼å»åº”ç”¨äº†

```js
{{obj.xxx}} => {{xxx}} //è¿™æ ·æ›´åŠ å¥½
```

**toRefs**çš„ä½¿ç”¨

:::details ä»£ç ç¤ºä¾‹
<template>
  <button @click="up">click</button>
  <h2>åå­—: {{ name }} å¹´é¾„ {{ age }}</h2>
</template>

<script>
import { reactive, toRefs }  from "vue";

export default {
  setup() {
    let state = reactive({
      age:18,
      name:'æå››'
    });
    function up() {
      state.age ++
    }
  
    return {
      up,
      ...toRefs(state)
    };
  },
};
</script>
:::

## ç»„åˆå¼apiçš„ä»£ç å¤ç”¨

ç»„åˆå¼apiçš„ä»£ç æ˜“å¤ç”¨æ€§ä¹Ÿæ˜¯å®ƒçš„ä¸€ä¸ªå¾ˆå¤§ç‰¹ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸€ä¸ªåŠŸèƒ½çš„ä»£ç å•ç‹¬æŠ½ç¦»æŠ½æ¥ï¼Œç„¶åå†åˆ°ç»„ä»¶ä¸­å¼•å…¥å¯¹äºçš„`useXxx.js`çš„åŠŸèƒ½ï¼Œè¿™æ ·ç»„ä»¶ä¸­çš„ä»£ç å°±å¯ä»¥å˜å¾—éå¸¸æ¸…æ™°ã€‚

æˆ‘è‡ªå·±çš„ä¸€ä¸ªä¹ æƒ¯æ˜¯ï¼Œå•ç‹¬ä¸€ä¸ªæ–‡ä»¶é‡Œé¢çš„ä»£ç æœ€å¥½ä¸è¦è¶…è¿‡300è¡Œï¼Œå•ç‹¬ä¸€ä¸ª`function`çš„ä»£ç ä¸è¦è¶…è¿‡10è¡Œ

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„`todo-list`æœªæ‹†åˆ†å’Œæ‹†åˆ†åçš„ç¤ºä¾‹

:::details æœªåˆ†ç¦»ç‰ˆæœ¬ã€ä»£ç ã€‘
```vue
<template>
  <div>
    <h1>todolist</h1>
    <div>
      <input type="text" v-model="val" placeholder="è¾“å…¥ä½ æƒ³åšçš„äº‹æƒ…" />
      <button @click="plus">å¢åŠ </button>
    </div>
    <ul>
      <li v-for="todo in todoList" :key="todo.name">  {{ todo.name }}</li>
    </ul>
    <div>total: {{ total }}</div>
  </div>
</template>
<script >
import { reactive, toRefs, computed } from "vue";
export default {
  setup() {
    let state = reactive({
      todoList: [
        { name: "å”±æ­Œ", done: false },
        { name: "ç¡è§‰", done: false },
        { name: "å­¦ä¹ ", done: false },
      ],
      val: "æˆ‘æƒ³åƒé¥­",
    });
    let total = computed(() => state.todoList.length);
    const plus = () => {
      state.todoList.push({
        name: state.val,
        done: false,
      });
      state.val = "";
    };
    return {
      ...toRefs(state),
      total,
      plus,
    };
  },
};
</script>
```
:::



:::details æŠ½ç¦»åçš„ç‰ˆæœ¬ã€ä»£ç ã€‘
`useTodo.js`
```js
import { reactive, computed } from "vue";

const useTodo = () => {
  let state = reactive({
    todoList: [
      { name: "å”±æ­Œ", done: false },
      { name: "ç¡è§‰", done: false },
      { name: "å­¦ä¹ ", done: false },
    ],
    val: "æˆ‘æƒ³åƒé¥­",
  });
  let total = computed(() => state.todoList.length);
  console.log(total);

  const plus = () => {
    state.todoList.push({
      name: state.val,
      done: false,
    });
    state.val = "";
  };
  return {
    state,
    total,
    plus,
  };
};

export default useTodo
```

**åœ¨ç»„ä»¶å†…ä½¿ç”¨**
```js
import useTodo from "./useTodo";
import { toRefs } from "vue";

export default {
  setup() {
    let { state, total, plus } = useTodo();

    return {
      total,
      plus,
      ...toRefs(state),
    };
  },
};
```
:::

## ç»„åˆå¼ apiçš„ç”Ÿå‘½å‘¨æœŸ

`setup`è¿™ä¸ªå‡½æ•°å…¥å£çš„è°ƒç”¨æ—¶æœºæ˜¯åœ¨ ä¼ ç»Ÿé’©å­`beforeCreate` ä¹‹å‰ï¼Œè€Œåœ¨`setup`å†…éƒ¨ä¹Ÿæœ‰ä¸€å¥—ç”Ÿå‘½å‘¨æœŸçš„é’©å­ä¾›æˆ‘ä»¬ä½¿ç”¨ ï¼Œ **è¿™äº›é’©å­å‡½æ•°åŒ…æ‹¬ä»¥ä¸Šçš„apiéƒ½éœ€è¦å†`setup`è¿™ä¸ªå‡½æ•°å†…è°ƒç”¨æ‰ç®—æœ‰æ•ˆ**

[ç»„åˆå¼apiçš„ç”Ÿå‘½å‘¨æœŸé’©å­æ–‡æ¡£ä¼ é€é—¨](https://vue3js.cn/docs/zh/guide/composition-api-lifecycle-hooks.html)

åœ¨æ–‡æ¡£ä¸­å·²ç»æœ‰è¯¦ç»†çš„ä»‹ç»ï¼Œæˆ‘ä»¬éœ€è¦å…³æ³¨çš„æ˜¯`setup`ä¸­å·²ç»æ²¡æœ‰`created`çš„é’©å­ï¼Œå› ä¸ºsetupæœ¬èº«å°±åšç€ç±»ä¼¼çš„äº‹æƒ…

æˆ‘ä»¬æœ€éœ€è¦å…³ç³»çš„ä¸¤ä¸ªé’©å­å°±æ˜¯`onMounted,onUnmount`,åˆ†åˆ«æ˜¯domæŒ‚åœ¨å®Œæ¯•ï¼Œå’Œç»„ä»¶å¸è½½ï¼Œè¿™åœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­ä½¿ç”¨é¢‘ç‡æœ€é«˜,

ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºè¿˜æ˜¯è¦æ¯”reactçš„hooksè¦å¥½ç†è§£çš„

```js
setup() {
  onMounted(()=>{
    console.log('ç»„ä»¶æŒ‚è½½å®Œæ¯•');
  })

  onUnmounted(()=>{
    console.log('ç»„ä»¶å¸è½½å®Œæ¯•');
  })
},
```

![alt](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/de01e730e563406cbf3399861fa23aa4~tplv-k3u1fbpfcp-zoom-1.image)

:::warning
åœ¨vue3ä¸­ä¸€äº›ç»„ä»¶çš„åå­—ä¹Ÿæ›´æ¢äº†ï¼Œä¸‹é¢è¿™å¼ å›¾å¯ä»¥æ›´åŠ æ¸…æ™°çš„è¡¨ç°å‡ºæ¥
:::
![alt](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3eadd1ec0ac94343951ae2453cf41fce~tplv-k3u1fbpfcp-zoom-1.image)


## watch å’Œ watchEffect  çš„ä½¿ç”¨

:::tip
`watch` å‡½æ•°ç”¨æ¥ä¾¦å¬ç‰¹å®šçš„æ•°æ®æºï¼Œå¹¶åœ¨å›è°ƒå‡½æ•°ä¸­æ‰§è¡Œå‰¯ä½œç”¨ã€‚é»˜è®¤æƒ…å†µæ˜¯æƒ°æ€§çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä»…åœ¨ä¾¦å¬çš„æºæ•°æ®å˜æ›´æ—¶æ‰æ‰§è¡Œå›è°ƒã€‚
:::
```js
watch(source, callback, [options])
```

### ç›‘å¬ref æ•°æ®

```js
let count = ref(10);
watch(count, (ov,nv) => {
  console.log("ğŸš€ ~ file: Test1.vue ~ line 15 ~ watch ~ nv", nv)
  console.log("ğŸš€ ~ file: Test1.vue ~ line 15 ~ watch ~ ov", ov)
});
```

### ç›‘å¬ `reactive` 
```js
let state = reactive({
  name: "å¼ ä¸‰",
  age: 18,
  like: ["åƒé¥­", "ç¡è§‰"],
});
watch(
  () => state.age,
  (ov, nv) => {
    console.log("ğŸš€ ~ file: Test1.vue ~ line 20 ~ watch ~ nv", nv);
    console.log("ğŸš€ ~ file: Test1.vue ~ line 20 ~ watch ~ ov", ov);
  }
);
```

### å¦‚æœæˆ‘ä»¬è¦ç›‘å¬å¯¹è±¡æˆ–è€…æ•°æ®çš„å˜åŒ–ï¼Œåªéœ€è¦åœ¨ç¬¬ä¸‰ä¸ªå‚æ•°åŠ ä¸Š `deep:true` å³å¯

```js
watch(
  () => state.like,
  (ov, nv) => {
    console.log("ğŸš€ ~ file: Test1.vue ~ line 20 ~ watch ~ nv", nv);
    console.log("ğŸš€ ~ file: Test1.vue ~ line 20 ~ watch ~ ov", ov);
  },{
    deep:true
  }
);
```

### åŒæ—¶ç›‘å¬å¤šä¸ªå€¼

```js
watch(
  [() => state.age, () => state.like, count],
  (...args) => {
    console.log("oldvalue", args[0]);
    console.log("newvalue", args[1]);
  },
  { deep: true }
);
```

### åœæ­¢ç›‘å¬

watchæ–¹æ³•å¯ä»¥è¿”è¿˜ä¸€ä¸ªæ–°çš„æ–¹æ³•ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•å°±å¯ä»¥åœæ­¢ç›‘å¬

```js
let watcher = watch(
  [() => state.age, () => state.like, count],
  (...args) => {
    if (args[1][2] > 15) {
      watcher();
    }
  },
  { deep: true }
);
```


### watchEffect çš„ä½¿ç”¨

watchEffect çš„åŠŸèƒ½å‡ ä¹å’Œwatchå·®ä¸å¤šï¼Œè¯­æ³•ç¨å¾®æœ‰äº›åŒºåˆ«

```js
const count = ref(0);
watchEffect(() => console.log(count.value));
```
## watchEffect å’Œ watch çš„ä¸»è¦åŒºåˆ«

1. watchEffectæ— æ³•æ‹¿åˆ°å˜æ›´å‰çš„å€¼
2. watchEffectåœ¨ç»„ä»¶åˆå§‹åŒ–çš„æ—¶å€™å°±ä¼šè°ƒç”¨ä¸€æ¬¡
3. watchEffectä¸éœ€è¦ä¼ å…¥ç›®æ ‡å€¼ï¼Œä¼šè‡ªåŠ¨æ”¶é›†callbackå†…éœ€è¦çš„å€¼è¿›è¡Œç›‘å¬ï¼ˆåƒä»¥ä¸Šå°±åªæœ‰`count`è¿™ä¸ªå€¼å‘ç”Ÿæ”¹å˜æ—¶ä¼šè§¦å‘å›è°ƒï¼‰